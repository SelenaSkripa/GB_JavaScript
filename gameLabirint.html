<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Игра лабиринт</title>
</head>

<body>
    <script>
        //       Данные:
        //           Игровое поле(прямоугольное, в каждой клетке есть свое состояние)
        var gameBoard = {
            cells: [],
            width: 0,
            height: 0,
            gameFinished: false,
            player: {}
        }
        //           Состояние игрока(координаты на игровом поле, направление, есть л у него ключ)
        var player = {
            coords: {
                x: 0,
                y: 0
            },
            direction: 'Up',
            haveKey: false,
            gameBoard: {}
        }
        //          Шаблон(ы) игрового поля
        var BOARD = ["==========",
            "=        =",
            "=  K     =",
            "=        =",
            "=     E  =",
            "=        =",
            "=        =",
            "=        =",
            "=========="
        ];

        var STARTPOSITION = {
            x: 1,
            y: 8,
            direction: "Right"
        }
        //        Алгоритм:
        //            Инициализация игры:
        //            Игровое поле:
        //            Копирование начального состояния из шаблона
        gameBoard.init = function (template, player) {
            this.height = template.length;
            this.width = template[0].length;
            this.cells = [];
            for (var j = 0; j < this.height; j++) {
                this.cells.push([]);
                for (var i = 0; i < this.width; i++) {
                    this.cells[j].push({});
                    switch (template[j][i]) {
                        case ' ':
                            this.cells[j][i].type = 'Free';
                            break;
                        case 'K':
                            this.cells[j][i].type = 'Key';
                            break;
                        case 'E':
                            this.cells[j][i].type = 'Exit';
                            break;
                        default:
                            this.cells[j][i].type = 'Wall';
                            break;
                    }
                }
            }
            this.gameFinished = false;
            this.player = player;
        }
        //        Состояние игрока:
        //            начальные координаты + направление
        //            ключ отсутсвует
        player.init = function (startPosition, gameBoard) {
            this.coords.x = startPosition.x;
            this.coords.y = startPosition.y;
            this.direction = startPosition.direction;
            this.haveKey = false;
            this.gameBoard = gameBoard;
        }

        gameBoard.init(BOARD, player);
        player.init(STARTPOSITION, gameBoard);

        var LEFTDIRECTION = {
            Left: 'Down',
            Up: 'Left',
            Right: 'Up',
            Down: 'Right'
        }
        var RIGTHDIRECTION = {
            Left: 'Up',
            Up: 'Right',
            Right: 'Down',
            Down: 'Left'
        }

        // Функция отображения поля
        gameBoard.renderBoard = function () {
            for (var j = 0; j < this.height; j++) {
                var line = '';
                for (var i = 0; i < this.width; i++) {
                    if (this.player.coords.x === i && this.player.coords.y === j) {
                        line += 'p';
                    } else {
                        switch (this.cells[j][i].type) {
                            case 'Free':
                                line += ' ';
                                break;
                            case 'Key':
                                line += 'K';
                                break;
                            case 'Exit':
                                line += 'E';
                                break;
                            case 'Wall':
                                line += '=';
                                break;
                        }
                    }
                }
                console.log(line + ' : ' + (j + '').padStart(3));
            }
            console.log(this.player);
        }

        // Проверка возможности сделать ход
        var DX = {
            Left: -1,
            Up: 0,
            Right: 1,
            Down: 0
        }
        var DY = {
            Left: 0,
            Up: -1,
            Right: 0,
            Down: 1
        }

        player.canMove = function () {
            var newX = this.coords.x = DX[this.direction];
            var newY = this.coords.y = DY[this.direction];
            if (this.gameBoard.cells[newY][newX].type === 'Wall') {
                return false;
            } else {
                return true;
            }
        }
        //            Проверить найден ли ключ

        player.checkKeyFound = function () {
            var newX = this.coords.x = DX[this.direction];
            var newY = this.coords.y = DY[this.direction];

            if (!this.haveKey && this.gameBoard.cells[newY][newX].type === 'Key') {
                alert('Вы нашли ключ! Ищите дверь!');
                this.gameBoard.cells[newY][newX].type = 'Free';
                this.haveKey = true;
            }
        }
        //            Проверить найден ли выход
        player.checkExitFound = function () {
            var newX = this.coords.x = DX[this.direction];
            var newY = this.coords.y = DY[this.direction];

            if (this.haveKey && this.gameBoard.cells[newY][newX].type === 'Exit') {
                alert('Вы нашли выход и открыли дверь!');
                this.gameBoard.gameFinished = true;
            }
        }
        //            Изменить положение игрока
        player.move = function () {
            this.coords.x = this.coords.x + DX[this.direction];
            this.coords.y = this.coords.y + DY[this.direction];
        }

        // Цикл игры

        while (!gameBoard.gameFinished) {
            //            Вывести состояние поля
            //            Вывести поле
            //            Отобразить игрока
            gameBoard.renderBoard();
            //            Спросить у пользователя шаг

            var step = prompt('Куда двигаемся? L - влево, R - вправо, G - вперед, Q - выход из игры');
            //            Выполнить шаг
            switch (step) {
                //        Поворот:
                //            Вычислить новое направление
                //            Изменить состояние игрока
                case 'l':
                    player.direction = LEFTDIRECTION[player.direction];
                    break;
                case 'r':
                    player.direction = RIGTHDIRECTION[player.direction];
                    break;
                    //        Вперед:
                case 'g':
                    //            Проверить возможность сделать шаг
                    if (player.canMove()) {
                        //            Проверить найден ли ключ
                        player.checkKeyFound();
                        //            Проверить найден ли выход
                        player.checkExitFound();
                        //            Изменить положение игрока
                        player.move();
                    }
                    break;
                case 'q':
                    gameBoard.gameFinished = true;
                    break;
                default:
                    alert('Неизвестная команда!');
                    break;
            }
        }

        //        Завершение:
        //            Позравление
        console.log('Поздавляем, Вы выиграли!')
    </script>
</body>

</html>